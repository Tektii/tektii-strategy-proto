syntax = "proto3";

package broker.v1;

// PreciseDecimal provides precision-safe decimal representation for financial calculations.
// This is critical for crypto (8+ decimals) and forex pip calculations.
message PreciseDecimal {
  // Scaled integer value
  int64 value = 1;
  // Number of decimal places
  int32 scale = 2;
  // Example: 1.23456 = {value: 123456, scale: 5}
}

// Candle represents OHLCV data for a time period.
message Candle {
  // Start of candle period in microseconds since epoch
  int64 timestamp_us = 1;
  // Opening price for the period
  PreciseDecimal open = 2;
  // Highest price during the period
  PreciseDecimal high = 3;
  // Lowest price during the period
  PreciseDecimal low = 4;
  // Closing price for the period
  PreciseDecimal close = 5;
  // Total volume traded during the period
  int64 volume = 6;
  // Volume-weighted average price for the period
  PreciseDecimal vwap = 7;
}

// Position represents a current position in a trading account.
message Position {
  // Trading symbol identifier
  string symbol = 1;
  // Position size (positive for long, negative for short)
  PreciseDecimal quantity = 2;
  // Average entry price for the position
  PreciseDecimal avg_price = 3;
  // Current market value of the position
  PreciseDecimal market_value = 4;
  // Unrealized profit/loss on the position
  PreciseDecimal unrealized_pnl = 5;
  // Realized profit/loss from closed portions
  PreciseDecimal realized_pnl = 6;
  // Current market price of the symbol
  PreciseDecimal current_price = 7;
}

// Trade represents an individual trade/deal that can be managed separately.
// Critical for hedging accounts where multiple trades can exist for the same symbol.
message Trade {
  // Unique trade identifier
  string trade_id = 1;
  // Trading symbol for this trade
  string symbol = 2;
  // Buy or sell side
  OrderSide side = 3;
  // Original trade quantity
  PreciseDecimal quantity = 4;
  // Remaining open quantity after partial closes
  PreciseDecimal remaining_quantity = 5;
  // Trade execution price
  PreciseDecimal entry_price = 6;
  // Trade execution time in microseconds since epoch
  int64 entry_timestamp_us = 7;
  // Current unrealized P&L for this trade
  PreciseDecimal unrealized_pnl = 8;
  // Realized P&L from partial closes of this trade
  PreciseDecimal realized_pnl = 9;

  // Protection orders attached to this specific trade
  // Stop loss order ID if attached
  string stop_loss_order_id = 10;
  // Take profit order ID if attached
  string take_profit_order_id = 11;

  // Trade costs and metadata
  // Commission paid for this trade
  PreciseDecimal commission = 12;
  // Additional fees for this trade
  PreciseDecimal fees = 13;
  // Broker-specific metadata
  map<string, string> metadata = 14;
}

// ErrorCode provides specific reasons for validation failures and order rejections.
// Used by both ValidateOrder (for pre-trade validation) and all order operations
// (PlaceOrder, ModifyOrder, CancelOrder, etc.) for rejection reasons.
enum ErrorCode {
  // Default unspecified error
  ERROR_CODE_UNSPECIFIED = 0;

  // Input validation errors (1-20)
  // Symbol not found or not tradeable
  ERROR_CODE_INVALID_SYMBOL = 1;
  // Quantity is invalid (e.g., zero, negative, or below minimum)
  ERROR_CODE_INVALID_QUANTITY = 2;
  // Price is invalid (e.g., negative or zero for limit orders)
  ERROR_CODE_INVALID_PRICE = 3;
  // Required field is missing or empty
  ERROR_CODE_MISSING_REQUIRED_FIELD = 4;
  // Fields have conflicting values
  ERROR_CODE_CONFLICTING_FIELDS = 5;

  // Account and margin errors (21-40)
  // Not enough margin or buying power for the order
  ERROR_CODE_INSUFFICIENT_MARGIN = 21;
  // Position size limit would be exceeded
  ERROR_CODE_POSITION_LIMIT = 22;
  // Account has trading restrictions
  ERROR_CODE_ACCOUNT_RESTRICTED = 23;

  // Market state errors (41-60)
  // Market is closed for trading
  ERROR_CODE_MARKET_CLOSED = 41;

  // Order state errors (61-80)
  // Order with same client ID already exists
  ERROR_CODE_DUPLICATE_ORDER = 61;
  // Order ID not found for modification or cancellation
  ERROR_CODE_ORDER_NOT_FOUND = 62;
  // Order is in a state that cannot be modified
  ERROR_CODE_ORDER_NOT_MODIFIABLE = 63;

  // System errors (81-100)
  // API rate limit exceeded
  ERROR_CODE_RATE_LIMIT = 81;
  // Pre-trade risk check failed
  ERROR_CODE_RISK_CHECK_FAILED = 82;
}

// StopOrder configuration for stop market orders.
message StopOrder {
  // Price at which to trigger a market order
  PreciseDecimal stop_price = 1;
}

// StopLimitOrder configuration for stop limit orders.
message StopLimitOrder {
  // Price at which to trigger the limit order
  PreciseDecimal stop_price = 1;
  // Limit price for the triggered order
  PreciseDecimal limit_price = 2;
}

// Order represents a trading order.
message Order {
  // Unique order identifier
  string order_id = 1;
  // Trading symbol for this order
  string symbol = 2;
  // Current status of the order
  OrderStatus status = 3;
  // Buy or sell side
  OrderSide side = 4;
  // Type of order (market, limit, etc.)
  OrderType order_type = 5;
  // Total order quantity
  PreciseDecimal quantity = 6;
  // Quantity already filled
  PreciseDecimal filled_quantity = 7;
  // Limit price for limit orders
  PreciseDecimal limit_price = 8;
  // Stop trigger price for stop orders
  PreciseDecimal stop_price = 9;
  // Order creation time in microseconds since epoch
  int64 created_at_us = 10;
  // Purpose of the order (open, close, stop loss, etc.)
  OrderIntent order_intent = 11;
  // Parent trade ID for protective orders
  string parent_trade_id = 12;
}

// OrderIntent indicates the purpose of an order for tracking and risk management.
enum OrderIntent {
  // Default unspecified order intent
  ORDER_INTENT_UNSPECIFIED = 0;
  // Opening a new position
  ORDER_INTENT_OPEN = 1;
  // Closing an existing position
  ORDER_INTENT_CLOSE = 2;
  // Protective stop loss order
  ORDER_INTENT_STOP_LOSS = 3;
  // Take profit order
  ORDER_INTENT_TAKE_PROFIT = 4;
}

// OrderSide indicates whether an order is to buy or sell.
enum OrderSide {
  // Default unspecified order side
  ORDER_SIDE_UNSPECIFIED = 0;
  // Buy order (long position)
  ORDER_SIDE_BUY = 1;
  // Sell order (short position)
  ORDER_SIDE_SELL = 2;
}

// OrderStatus represents the current state of an order in its lifecycle.
enum OrderStatus {
  // Default unspecified order status
  ORDER_STATUS_UNSPECIFIED = 0;
  // Order has been received but not yet submitted to market
  ORDER_STATUS_PENDING = 1;
  // Order has been sent to the exchange
  ORDER_STATUS_SUBMITTED = 2;
  // Order has been accepted by the exchange
  ORDER_STATUS_ACCEPTED = 3;
  // Order has been partially filled
  ORDER_STATUS_PARTIAL = 4;
  // Order has been completely filled
  ORDER_STATUS_FILLED = 5;
  // Order has been canceled
  ORDER_STATUS_CANCELED = 6;
  // Order has been rejected by broker/exchange
  ORDER_STATUS_REJECTED = 7;
  // Order has expired (e.g., DAY orders at market close)
  ORDER_STATUS_EXPIRED = 8;
}

// OrderType specifies how an order should be executed.
enum OrderType {
  // Default unspecified order type
  ORDER_TYPE_UNSPECIFIED = 0;
  // Execute immediately at current market price
  ORDER_TYPE_MARKET = 1;
  // Execute at specified price or better
  ORDER_TYPE_LIMIT = 2;
  // Stop market order triggered at stop price
  ORDER_TYPE_STOP = 3;
  // Stop order that becomes limit order when triggered
  ORDER_TYPE_STOP_LIMIT = 4;
}

// Broker represents the trading platform or broker.
enum Broker {
  // Default unspecified broker
  BROKER_UNSPECIFIED = 0;
  // Tektii's backtesting environment
  BROKER_BACKTESTING = 1;
  // Alpaca trading platform
  BROKER_ALPACA = 2;
  // Interactive Brokers trading platform
  BROKER_INTERACTIVE_BROKERS = 3;
  // Binance cryptocurrency exchange
  BROKER_BINANCE = 4;

  // More coming soon...
}
